<!DOCTYPE html><html lang="zh_CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>一起写webserver 项目(四) | My Blog</title><meta name="author" content="YeSho"><meta name="copyright" content="YeSho"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="description" content="http连接的封装先前我们写的线程，数据库池或者底层的小工具如locker锁等东西是地基，是骨架，那么http解析部分就是主体，是血肉。这是这个项目最关键的部分。  下面是一张简易的框架图，首先说明一下这个WebServer的本质，WebServer的本质上是⼀个⾼性能⽹络框架，它提供了⼀个单服务端（当然也可以扩展为多服务端）与多客户端的⾼效连接框架，但是客户端与服务端连接上以后具体应该做些什么（">
<meta property="og:type" content="article">
<meta property="og:title" content="一起写webserver 项目(四)">
<meta property="og:url" content="https://www.yesho.top/2024/04/30/%E4%B8%80%E8%B5%B7%E5%86%99webserver%20%E9%A1%B9%E7%9B%AE(%E5%9B%9B)/index.html">
<meta property="og:site_name" content="My Blog">
<meta property="og:description" content="http连接的封装先前我们写的线程，数据库池或者底层的小工具如locker锁等东西是地基，是骨架，那么http解析部分就是主体，是血肉。这是这个项目最关键的部分。  下面是一张简易的框架图，首先说明一下这个WebServer的本质，WebServer的本质上是⼀个⾼性能⽹络框架，它提供了⼀个单服务端（当然也可以扩展为多服务端）与多客户端的⾼效连接框架，但是客户端与服务端连接上以后具体应该做些什么（">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20241216191558.png">
<meta property="article:published_time" content="2024-04-30T12:39:33.674Z">
<meta property="article:modified_time" content="2024-06-05T07:54:02.341Z">
<meta property="article:author" content="YeSho">
<meta property="article:tag" content="项目">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20241216191558.png"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="https://www.yesho.top/2024/04/30/%E4%B8%80%E8%B5%B7%E5%86%99webserver%20%E9%A1%B9%E7%9B%AE(%E5%9B%9B)/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Error',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: true,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"You have switched to Traditional Chinese","cht_to_chs":"You have switched to Simplified Chinese","day_to_night":"You have switched to Dark Mode","night_to_day":"You have switched to Light Mode","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"top-right"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '一起写webserver 项目(四)',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-06-05 15:54:02'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/iconfont.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://avatars.githubusercontent.com/u/101156528?v=4" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">7</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">3</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">2</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg fixed" id="page-header" style="background-image: url('http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20241216191558.png')"><nav id="nav"><span id="blog-info"><a href="/" title="My Blog"><span class="site-name">My Blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 列表</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">一起写webserver 项目(四)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2024-04-30T12:39:33.674Z" title="Created 2024-04-30 20:39:33">2024-04-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2024-06-05T07:54:02.341Z" title="Updated 2024-06-05 15:54:02">2024-06-05</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E4%B8%80%E8%B5%B7%E5%81%9A%E9%A1%B9%E7%9B%AE/">一起做项目</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word Count:</span><span class="word-count">4.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading Time:</span><span>20mins</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="一起写webserver 项目(四)"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="http连接的封装"><a href="#http连接的封装" class="headerlink" title="http连接的封装"></a>http连接的封装</h2><p>先前我们写的线程，数据库池或者底层的小工具如locker锁等东西是地基，是骨架，那么http解析部分就是主体，是血肉。这是这个项目最关键的部分。</p>
<blockquote>
<p>下面是一张简易的框架图，首先说明一下这个WebServer的本质，WebServer的本质上是⼀个<strong>⾼性能⽹络框架</strong>，它提供了⼀个单服务端（当然也可以扩展为多服务端）与多客户端的⾼效连接框架，但是客户端与服务端连接上以后具体应该做些什么（也就是有哪些业务），这就可以由我们⾃由发挥了，这就是 WebServer 的功能扩展。⽬前⼤多数的WebServer都将从服务端获取<strong>MIME</strong>作为主要功能。</p>
</blockquote>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20240430204114.png " alt="image.png" style="zoom:80%;" />


<p>由于变量和参数过多，先不介绍初始化了，先从设计讲起。</p>
<h3 id="http-conn的设计"><a href="#http-conn的设计" class="headerlink" title="http_conn的设计"></a>http_conn的设计</h3><p>其中大部分设计都是参考了《Linux高性能服务器编程》</p>
<h4 id="固定的一些方法和变量"><a href="#固定的一些方法和变量" class="headerlink" title="固定的一些方法和变量"></a>固定的一些方法和变量</h4><p>定义http响应的一些状态信息</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">char</span> *ok_200_title = <span class="string">&quot;OK&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *error_400_title = <span class="string">&quot;Bad Request&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *error_400_form = <span class="string">&quot;Your request has bad syntax or is inherently impossible to staisfy.\n&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *error_403_title = <span class="string">&quot;Forbidden&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *error_403_form = <span class="string">&quot;You do not have permission to get file form this server.\n&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *error_404_title = <span class="string">&quot;Not Found&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *error_404_form = <span class="string">&quot;The requested file was not found on this server.\n&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *error_500_title = <span class="string">&quot;Internal Error&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *error_500_form = <span class="string">&quot;There was an unusual problem serving the request file.\n&quot;</span>;</span><br></pre></td></tr></table></figure>


<p>类内的方法枚举,</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">METHOD</span></span><br><span class="line">&#123;</span><br><span class="line">	GET = <span class="number">0</span>,</span><br><span class="line">	POST,</span><br><span class="line">	HEAD,</span><br><span class="line">	PUT,</span><br><span class="line">	DELETE,</span><br><span class="line">	TRACE,</span><br><span class="line">	OPTIONS,</span><br><span class="line">	CONNECT,</span><br><span class="line">	PATCH</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>分析状态，这些状态是解析请求的不同阶段，所有的完成后我们才能回应响应</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">CHECK_STATE</span></span><br><span class="line">&#123;</span><br><span class="line">    CHECK_STATE_REQUESTLINE = <span class="number">0</span>, <span class="comment">// 当前正在分析请求行</span></span><br><span class="line">    CHECK_STATE_HEADER, <span class="comment">// 当前正在分析请求头</span></span><br><span class="line">    CHECK_STATE_CONTENT <span class="comment">// 当前正在分析请求体</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>请求结果枚举</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">HTTP_CODE</span></span><br><span class="line">&#123;</span><br><span class="line">    NO_REQUEST, <span class="comment">// 表示请求不完整，需要继续读取客户数据  这是解析请求的不同阶段的默认返回值</span></span><br><span class="line">    GET_REQUEST, <span class="comment">// 表示获得了一个完整的客户请求  只有这个完成后我们才能进行</span></span><br><span class="line">    BAD_REQUEST, <span class="comment">// 表示客户请求有语法错误 </span></span><br><span class="line">    NO_RESOURCE, <span class="comment">// 请求的资源不存在</span></span><br><span class="line">    FORBIDDEN_REQUEST, <span class="comment">// 表示客户对资源没有足够的访问权限</span></span><br><span class="line">    FILE_REQUEST, <span class="comment">// 这是一个文件请求</span></span><br><span class="line">    INTERNAL_ERROR, <span class="comment">// 表示服务器内部错误；</span></span><br><span class="line">    CLOSED_CONNECTION <span class="comment">// 表示客户端已经关闭连接了</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>状态行</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">LINE_STATUS</span></span><br><span class="line">&#123;</span><br><span class="line">    LINE_OK = <span class="number">0</span>,</span><br><span class="line">    LINE_BAD,</span><br><span class="line">    LINE_OPEN</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<p>一些固定常用方法，具体的实现就不展示了，也可以在《Linux高性能服务器编程》找到</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">setnonblocking</span><span class="params">(<span class="type">int</span> fd)</span> <span class="comment">// 对文件描述符设置非阻塞</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">addfd</span><span class="params">(<span class="type">int</span> epollfd, <span class="type">int</span> fd, <span class="type">bool</span> one_shot, <span class="type">int</span> TRIGMode)</span> <span class="comment">//将内核事件表注册读事件，ET模式，选择开启EPOLLONESHOT</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">removefd</span><span class="params">(<span class="type">int</span> epollfd, <span class="type">int</span> fd)</span> <span class="comment">//从内核时间表删除描述符</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">modfd</span><span class="params">(<span class="type">int</span> epollfd, <span class="type">int</span> fd, <span class="type">int</span> ev, <span class="type">int</span> TRIGMode)</span> <span class="comment">//将事件重置为EPOLLONESHOT</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">http_conn::unmap</span><span class="params">()</span></span>; <span class="comment">// 解除内存映射，并将资源文件到内存的m_file_address重置</span></span><br></pre></td></tr></table></figure>


<h3 id="read-once"><a href="#read-once" class="headerlink" title="read_once()"></a>read_once()</h3><p>设置都有读写缓存区，分别是<code>m_read_buf</code>和<code>m_write_buf</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> m_read_buf[READ_BUFFER_SIZE]&#123;&#125;;</span><br><span class="line"><span class="type">int</span> m_read_idx&#123;&#125;;</span><br><span class="line"><span class="type">int</span> m_check_idx&#123;&#125;;</span><br><span class="line"><span class="type">char</span> m_write_buf[WRITE_BUFFER_SIZE]&#123;&#125;;</span><br><span class="line"><span class="type">int</span> m_write_idx&#123;&#125;;</span><br><span class="line"><span class="type">int</span> m_start_line&#123;&#125;;</span><br></pre></td></tr></table></figure>


<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20240430171402.png" alt="image.png" style="zoom:60%;" />

<ul>
<li><code>m_read_idx</code>:代表从客户端接受的数据的末尾位置。</li>
<li><code>m_check_idx</code>:用来标记当前正在检查的字符的位置。</li>
<li><code>m_start_line</code>: 用来标记缓冲区中当前处理的行的起始位置。</li>
</ul>
<p><code>read_once</code>这个函数主要完成将数据读到缓冲区，定义了一块缓冲区<code>m_read_buf</code>专门用来存放从浏览器发送来的请求报文，并用一个指针<code>m_read_idx</code>记录,这里分LT、ET模式，在LT模式下，<code>epoll_wait</code>会无数次地通知应用程序读事件的发生，直到应用程序去取。这里的应用程序是什么呢？很显然就是下面这个<code>read_once()</code>代码，在<code>if(m_TRIGMode == 0)</code>程序块里，应用程序用<code>recv</code>去将sockfd内的内容取到<code>m_readbuf</code>里面，如果没有取完，程序是无所谓的，它会继续往下执行，直到下一次epoll_wait再次通知，它便再进行recv操作。</p>
<p>而在ET模式下，epoll_wait只会通知应用程序一次，应用程序被要求在这一次就把sockfd中全部的数据取出，即read_once，可以看到在ET模式下，代码执行一个永不结束的循环while(true），唯有当数据全部取完（即recv返回-1并设置errno为EAGAIN或EWOULDBLOCK)时，程序才会退出，不然程序就一直循环下去。（其实当对方关闭了sock连接也会退出，但这就属于异常处理的流程，而非常规流程了）</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">http_conn::read_once</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(m_read_idx&gt;=READ_BUFFER_SIZE)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">int</span> read_ret=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span>(m_TRIGMode==<span class="number">0</span>)&#123; <span class="comment">// LT模式</span></span><br><span class="line">    read_ret= <span class="built_in">recv</span>(m_sock_fd,m_read_buf+m_read_idx,READ_BUFFER_SIZE-m_read_idx,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(read_ret&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    m_read_idx+=read_ret;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span>&#123; <span class="comment">// ET 模式</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">      read_ret= <span class="built_in">recv</span>(m_sock_fd,m_read_buf+m_read_idx,READ_BUFFER_SIZE-m_read_idx,<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">if</span>(read_ret==<span class="number">-1</span>)&#123; <span class="comment">// // 这两个错误表明在非阻塞模式下没有数据可读。这是正常的</span></span><br><span class="line">        <span class="keyword">if</span>(errno==EAGAIN||errno==EWOULDBLOCK)&#123;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span>(read_ret==<span class="number">0</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      m_read_idx+=read_ret;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="process"><a href="#process" class="headerlink" title="process"></a>process</h3><p>这是http最为核心的函数了，这是线程池工作线程不断循环执行的逻辑了</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20240430165359.png" alt="image.png" style="zoom:60%;" />

<p>主要执行process_read和process_write。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">http_conn::process</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  HTTP_CODE read_ret = <span class="built_in">process_read</span>();</span><br><span class="line">  <span class="keyword">if</span>(read_ret==NO_REQUEST)&#123;</span><br><span class="line">    <span class="built_in">modfd</span>(m_epoll_fd,m_sock_fd,EPOLLIN,m_TRIGMode);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">bool</span> write_ret= <span class="built_in">process_write</span>(read_ret);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(!write_ret)&#123;</span><br><span class="line">    <span class="built_in">close_conn</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">modfd</span>(m_epoll_fd,m_sock_fd,EPOLLOUT,m_TRIGMode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="process-read"><a href="#process-read" class="headerlink" title="process_read"></a>process_read</h4><p>process_read用来处理连接，我们设计了两个状态机<strong>主状态机&#x2F;从状态机</strong>来进行报文解析。下图是处理连接的拓扑图： </p>
<ul>
<li>从状态机负责读取一行的数据</li>
<li>当从状态机成功读完一行后，就将这行数据交给主状态机</li>
<li>主状态机会根据报文格式以及自身状态对该请求行进行解析</li>
<li>解析完后主状态机的状态改变，切换到下一个状态再等待从状态机的数据循环、</li>
</ul>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20240430184115.png" alt="image.png" style="zoom:60%;" />



<p>从上面的<code>read_once()</code>函数中我们获得了一个字符数组<code>m_read_buf</code>，和一个指针<code>m_read_idx</code>。我们开始读取m_read_buf至今为止保存的内容。这时我们需要创建一个新的指针<code>m_checked_idx</code>来记录每一行报文的结束地址。</p>
<p>下面是process_read流程图，</p>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20240430183621.png" alt="image.png" style="zoom:100%;" />


<h5 id="parse-line"><a href="#parse-line" class="headerlink" title="parse_line"></a>parse_line</h5><p>因为http报文是<strong>按行来分开</strong>不同的信息的，而发送过来的数据要按行处理分出一行的内容，因为报文的行都是以<code>＜CR＞＜LF＞</code>结束,我们可以通过这个条件让指针<code>m_checked_idx</code>来记录每一行报文的结束地址。当<code>m_checked_idx</code>在一行报文的末尾时，那<code>m_start_line</code>到<code>m_checked_idx</code>就是一行的首尾了。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//从状态机，用于分析出一行内容</span></span><br><span class="line"><span class="comment">//返回值为行的读取状态，有LINE_OK,LINE_BAD,LINE_OPEN</span></span><br><span class="line"><span class="function">http_conn::LINE_STATUS <span class="title">http_conn::parse_line</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">char</span> temp;</span><br><span class="line">  <span class="keyword">for</span>(;m_check_idx&lt;m_read_idx;++m_check_idx)&#123;</span><br><span class="line">    temp=m_read_buf[m_check_idx];</span><br><span class="line">    <span class="keyword">if</span>(temp==<span class="string">&#x27;\r&#x27;</span>)&#123;</span><br><span class="line">      <span class="keyword">if</span>(m_check_idx+<span class="number">1</span>==m_read_idx)</span><br><span class="line">        <span class="keyword">return</span> LINE_OPEN;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span>(m_read_buf[m_check_idx+<span class="number">1</span>]==<span class="string">&#x27;\n&#x27;</span>)&#123;</span><br><span class="line">        m_read_buf[m_check_idx++]=<span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        m_read_buf[m_check_idx++]=<span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span> LINE_OK;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> LINE_BAD;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(temp==<span class="string">&#x27;\n&#x27;</span>)&#123;</span><br><span class="line">      <span class="keyword">if</span>(m_check_idx&gt;<span class="number">1</span>&amp;&amp;m_read_buf[m_check_idx<span class="number">-1</span>]==<span class="string">&#x27;\r&#x27;</span>)&#123;</span><br><span class="line">        m_read_buf[m_check_idx<span class="number">-1</span>]=<span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        m_read_buf[m_check_idx++]=<span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span> LINE_OK;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> LINE_BAD;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> LINE_OPEN;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而<code>get_line</code>就是一行内容了，因为我们在末尾都赋值了<code>\0</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">text = <span class="built_in">get_line</span>();</span><br><span class="line"><span class="function"><span class="type">char</span> *<span class="title">get_line</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> m_read_buf+m_start_line;&#125;;</span><br><span class="line">ret = <span class="built_in">parse_request_line</span>(text);</span><br></pre></td></tr></table></figure>

<h5 id="parse-request-line"><a href="#parse-request-line" class="headerlink" title="parse_request_line"></a>parse_request_line</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">METHOD m_method; <span class="comment">// 请求方法</span></span><br><span class="line"><span class="type">char</span> *m_url&#123;&#125;;  <span class="comment">// url 比如 http://www.baidu.com/index.html</span></span><br><span class="line"><span class="type">char</span> *m_version&#123;&#125;; <span class="comment">// http 版本</span></span><br><span class="line"><span class="type">int</span> cgi&#123;&#125;; <span class="comment">//是否启用的POST</span></span><br></pre></td></tr></table></figure>

<p>这个函数主要用来解析请求行 比如<code>GET http://www.baidu.com/index.html HTTP/1.0</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">http_conn::HTTP_CODE <span class="title">http_conn::parse_request_line</span><span class="params">(<span class="type">char</span> *text)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  m_url = <span class="built_in">strpbrk</span>(text, <span class="string">&quot; \t&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!m_url)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> BAD_REQUEST;</span><br><span class="line">  &#125;</span><br><span class="line">  *m_url++ = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">  <span class="type">char</span> *method = text;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strcasecmp</span>(method, <span class="string">&quot;GET&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">    m_method = GET;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcasecmp</span>(method, <span class="string">&quot;POST&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    m_method = POST;</span><br><span class="line">    cgi = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> BAD_REQUEST;</span><br><span class="line">  m_url += <span class="built_in">strspn</span>(m_url, <span class="string">&quot; \t&quot;</span>); <span class="comment">// 这里主要用于去除m_url多余的空格</span></span><br><span class="line">  m_version = <span class="built_in">strpbrk</span>(m_url, <span class="string">&quot; \t&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!m_version)</span><br><span class="line">    <span class="keyword">return</span> BAD_REQUEST;</span><br><span class="line">  *m_version++ = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">  m_version += <span class="built_in">strspn</span>(m_version, <span class="string">&quot; \t&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strcasecmp</span>(m_version, <span class="string">&quot;HTTP/1.1&quot;</span>) != <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> BAD_REQUEST;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strncasecmp</span>(m_url, <span class="string">&quot;http://&quot;</span>, <span class="number">7</span>) == <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    m_url += <span class="number">7</span>;</span><br><span class="line">    m_url = <span class="built_in">strchr</span>(m_url, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strncasecmp</span>(m_url, <span class="string">&quot;https://&quot;</span>, <span class="number">8</span>) == <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    m_url += <span class="number">8</span>;</span><br><span class="line">    m_url = <span class="built_in">strchr</span>(m_url, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!m_url || m_url[<span class="number">0</span>] != <span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> BAD_REQUEST;</span><br><span class="line">  <span class="comment">//当url为/时，显示判断界面</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strlen</span>(m_url) == <span class="number">1</span>)</span><br><span class="line">    <span class="built_in">strcat</span>(m_url, <span class="string">&quot;judge.html&quot;</span>);</span><br><span class="line">  m_check_state = CHECK_STATE_HEADER;</span><br><span class="line">  <span class="keyword">return</span> NO_REQUEST;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="parse-headers"><a href="#parse-headers" class="headerlink" title="parse_headers"></a>parse_headers</h5><p>解析完请求行，我们再来解析请求头部，根据报文格式，以及头部字段名的种类，我们有下面的代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> m_linger&#123;&#125;; <span class="comment">// 是否保持连接</span></span><br><span class="line"><span class="type">long</span> m_content_length&#123;&#125;;</span><br><span class="line"><span class="type">char</span> *m_host&#123;&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//解析http请求的一个头部信息</span></span><br><span class="line"><span class="function">http_conn::HTTP_CODE <span class="title">http_conn::parse_headers</span><span class="params">(<span class="type">char</span> *text)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (text[<span class="number">0</span>] == <span class="string">&#x27;\0&#x27;</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (m_content_length != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      m_check_state = CHECK_STATE_CONTENT;</span><br><span class="line">      <span class="keyword">return</span> NO_REQUEST;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> GET_REQUEST;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncasecmp</span>(text, <span class="string">&quot;Connection:&quot;</span>, <span class="number">11</span>) == <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    text += <span class="number">11</span>;</span><br><span class="line">    text += <span class="built_in">strspn</span>(text, <span class="string">&quot; \t&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcasecmp</span>(text, <span class="string">&quot;keep-alive&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      m_linger = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncasecmp</span>(text, <span class="string">&quot;Content-length:&quot;</span>, <span class="number">15</span>) == <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    text += <span class="number">15</span>;</span><br><span class="line">    text += <span class="built_in">strspn</span>(text, <span class="string">&quot; \t&quot;</span>);</span><br><span class="line">    m_content_length = <span class="built_in">atol</span>(text);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strncasecmp</span>(text, <span class="string">&quot;Host:&quot;</span>, <span class="number">5</span>) == <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    text += <span class="number">5</span>;</span><br><span class="line">    text += <span class="built_in">strspn</span>(text, <span class="string">&quot; \t&quot;</span>);</span><br><span class="line">    m_host = text;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;oop!unknown header: %s&quot;</span>, text)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> NO_REQUEST;</span><br></pre></td></tr></table></figure>

<h5 id="parse-content"><a href="#parse-content" class="headerlink" title="parse_content"></a>parse_content</h5><p>如果时post请求还要解析请求体</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span>* m_string&#123;&#125;; <span class="comment">//存储请求体数据</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">http_conn::HTTP_CODE <span class="title">http_conn::parse_content</span><span class="params">(<span class="type">char</span> *text)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(m_read_idx&gt;=(m_content_length+m_check_idx))&#123;</span><br><span class="line">    text[m_content_length]=<span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="comment">//POST请求中最后为输入的用户名和密码</span></span><br><span class="line">    m_string=text;</span><br><span class="line">    <span class="keyword">return</span> GET_REQUEST;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> NO_REQUEST;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="process-read-1"><a href="#process-read-1" class="headerlink" title="process_read"></a>process_read</h5><p>在POST请求报文中，因为消息体结尾没有 <code>\r\n</code> ，所以不会触发<code>parse_line()</code>解析，所以我们只能根据主状态机进行条件判断进入循环。但这会有个问题，等POST请求报文全部解析完后，m_check_state依然是<code>CHECK_STATE_CONTENT</code>,还是不会退出循环。这不是我们所希望的，所以我们让它加上<code>line_status == LINE_OK</code>,这样当POST消息体全部解析完后，<code>line_status</code>会被赋值为<code>LINE_OPEN</code>,就不再进入主循环</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">http_conn::HTTP_CODE <span class="title">http_conn::process_read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  LINE_STATUS line_status=LINE_OK;</span><br><span class="line">  HTTP_CODE ret=NO_REQUEST;</span><br><span class="line">  <span class="type">char</span> *text=<span class="literal">nullptr</span>;</span><br><span class="line">  <span class="keyword">while</span> ((m_check_state == CHECK_STATE_CONTENT &amp;&amp; line_status == LINE_OK) || ((line_status = <span class="built_in">parse_line</span>()) == LINE_OK))</span><br><span class="line">  &#123;</span><br><span class="line">    text = <span class="built_in">get_line</span>();</span><br><span class="line">    m_start_line = m_check_idx;</span><br><span class="line">    <span class="built_in">LOG_INFO</span>(<span class="string">&quot;%s&quot;</span>, text)</span><br><span class="line">    <span class="keyword">switch</span> (m_check_state)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> CHECK_STATE_REQUESTLINE:</span><br><span class="line">      &#123;</span><br><span class="line">        ret = <span class="built_in">parse_request_line</span>(text);</span><br><span class="line">        <span class="keyword">if</span> (ret == BAD_REQUEST)</span><br><span class="line">          <span class="keyword">return</span> BAD_REQUEST;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> CHECK_STATE_HEADER:</span><br><span class="line">      &#123;</span><br><span class="line">        ret = <span class="built_in">parse_headers</span>(text);</span><br><span class="line">        <span class="keyword">if</span> (ret == BAD_REQUEST)</span><br><span class="line">          <span class="keyword">return</span> BAD_REQUEST;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (ret == GET_REQUEST)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="built_in">do_request</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">case</span> CHECK_STATE_CONTENT:</span><br><span class="line">      &#123;</span><br><span class="line">        ret = <span class="built_in">parse_content</span>(text);</span><br><span class="line">        <span class="keyword">if</span> (ret == GET_REQUEST)</span><br><span class="line">          <span class="keyword">return</span> <span class="built_in">do_request</span>(); <span class="comment">// 才具备了执行do_request的充分条件</span></span><br><span class="line">        line_status = LINE_OPEN;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> INTERNAL_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> NO_REQUEST;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="do-request"><a href="#do-request" class="headerlink" title="do_request"></a>do_request</h4><p>因为客户端主要从服务端获取<strong>MIME</strong>作为主要功能，客户发起了一个图片的请求<code>http://xxx/images/pic.jpg</code>,在服务端来说这是一个链接，在服务端那边就是一个请求资源文件的路径，服务端根据请求的<code>URL</code>路径，去其文件系统中寻找对应的文件。如果文件存在，服务端将继续处理；如果文件不存在，则通常返回404错误（资源未找到）。</p>
<p><code>do_request()</code>主要目的是解析HTTP请求URL，根据不同的路径（URL中的部分内容）来执行不同的操作，例如处理CGI请求（如登录、注册等），处理静态文件请求等。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> m_real_file[FILENAME_LEN]&#123;&#125;;</span><br><span class="line"><span class="type">char</span>* doc_root&#123;&#125;; <span class="comment">// 服务器上用于存放网页文件的根目录的路径</span></span><br><span class="line"><span class="type">char</span> *m_file_address&#123;&#125;; <span class="comment">// 请求文件被mmap到内存中的位置</span></span><br></pre></td></tr></table></figure>

<p>其实本质上这个函数是为了得到<code>m_real_file</code>,资源文件的路径，得到<code>m_real_file</code>后<strong>映射文件内容到内存</strong>，这样操作系统可以利用虚拟内存系统来访问文件，文件的读取和写入就像访问普通内存一样高效。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">http_conn::HTTP_CODE <span class="title">http_conn::do_request</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">strcpy</span>(m_real_file,doc_root);</span><br><span class="line">  <span class="type">int</span> len= <span class="built_in">strlen</span>(doc_root);</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *p= <span class="built_in">strrchr</span>(m_url,<span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">  <span class="comment">//处理cgi</span></span><br><span class="line">  <span class="keyword">if</span> (cgi == <span class="number">1</span> &amp;&amp; (*(p + <span class="number">1</span>) == <span class="string">&#x27;2&#x27;</span> || *(p + <span class="number">1</span>) == <span class="string">&#x27;3&#x27;</span>)) <span class="comment">// 服务器优化设计定的动作对应特定的数字标识 2代表登录 3代表注册</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">//根据标志判断是登录检测还是注册检测</span></span><br><span class="line">    <span class="type">char</span> flag = m_url[<span class="number">1</span>]; <span class="comment">//m_url:/2CGISQL.cgi</span></span><br><span class="line">    <span class="type">char</span> *m_url_real = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="type">char</span>) * <span class="number">200</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(m_url_real, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">    <span class="built_in">strcat</span>(m_url_real, m_url + <span class="number">2</span>);</span><br><span class="line">    <span class="built_in">strncpy</span>(m_real_file + len, m_url_real, FILENAME_LEN - len - <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">free</span>(m_url_real);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将用户名和密码提取出来</span></span><br><span class="line">    <span class="comment">//user=123&amp;passwd=123</span></span><br><span class="line">    <span class="type">char</span> name[<span class="number">100</span>], password[<span class="number">100</span>];</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">5</span>; m_string[i] != <span class="string">&#x27;&amp;&#x27;</span>; ++i)</span><br><span class="line">      name[i - <span class="number">5</span>] = m_string[i];</span><br><span class="line">    name[i - <span class="number">5</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> j = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (i = i + <span class="number">10</span>; m_string[i] != <span class="string">&#x27;\0&#x27;</span>; ++i, ++j)</span><br><span class="line">      password[j] = m_string[i];</span><br><span class="line">    password[j] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (*(p + <span class="number">1</span>) == <span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">//如果是注册，先检测数据库中是否有重名的</span></span><br><span class="line">      <span class="comment">//没有重名的，进行增加数据</span></span><br><span class="line">      <span class="type">char</span> *sql_insert = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="type">char</span>) * <span class="number">200</span>);</span><br><span class="line"></span><br><span class="line">      <span class="built_in">snprintf</span>(sql_insert, <span class="built_in">strlen</span>(sql_insert), <span class="string">&quot;INSERT INTO user(username, passwd) VALUES(&#x27;%s&#x27;, &#x27;%s&#x27;)&quot;</span>,name,password);</span><br><span class="line">      m_lock.<span class="built_in">lock</span>();</span><br><span class="line">      <span class="keyword">if</span> (users.<span class="built_in">find</span>(name) == users.<span class="built_in">end</span>())</span><br><span class="line">      &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> res = <span class="built_in">mysql_query</span>(mysql, sql_insert);</span><br><span class="line">        users.<span class="built_in">insert</span>(<span class="built_in">pair</span>&lt;string, string&gt;(name, password));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!res)</span><br><span class="line">          <span class="built_in">strcpy</span>(m_url, <span class="string">&quot;/log.html&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          <span class="built_in">strcpy</span>(m_url, <span class="string">&quot;/registerError.html&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">strcpy</span>(m_url, <span class="string">&quot;/registerError.html&quot;</span>);</span><br><span class="line">      m_lock.<span class="built_in">unlock</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//如果是登录，直接判断</span></span><br><span class="line">    <span class="comment">//若浏览器端输入的用户名和密码在表中可以查找到，返回1，否则返回0</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (*(p + <span class="number">1</span>) == <span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (users.<span class="built_in">find</span>(name) != users.<span class="built_in">end</span>() &amp;&amp; users[name] == password)</span><br><span class="line">        <span class="built_in">strcpy</span>(m_url, <span class="string">&quot;/welcome.html&quot;</span>);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">strcpy</span>(m_url, <span class="string">&quot;/logError.html&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (*(p + <span class="number">1</span>) == <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="type">char</span> *m_url_real = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="type">char</span>) * <span class="number">200</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(m_url_real, <span class="string">&quot;/register.html&quot;</span>);</span><br><span class="line">    <span class="built_in">strncpy</span>(m_real_file + len, m_url_real, <span class="built_in">strlen</span>(m_url_real));</span><br><span class="line">    <span class="built_in">free</span>(m_url_real);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (*(p + <span class="number">1</span>) == <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="type">char</span> *m_url_real = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="type">char</span>) * <span class="number">200</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(m_url_real, <span class="string">&quot;/log.html&quot;</span>);</span><br><span class="line">    <span class="built_in">strncpy</span>(m_real_file + len, m_url_real, <span class="built_in">strlen</span>(m_url_real));</span><br><span class="line">    <span class="built_in">free</span>(m_url_real);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (*(p + <span class="number">1</span>) == <span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="type">char</span> *m_url_real = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="type">char</span>) * <span class="number">200</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(m_url_real, <span class="string">&quot;/picture.html&quot;</span>);</span><br><span class="line">    <span class="built_in">strncpy</span>(m_real_file + len, m_url_real, <span class="built_in">strlen</span>(m_url_real));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(m_url_real);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (*(p + <span class="number">1</span>) == <span class="string">&#x27;6&#x27;</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="type">char</span> *m_url_real = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="type">char</span>) * <span class="number">200</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(m_url_real, <span class="string">&quot;/video.html&quot;</span>);</span><br><span class="line">    <span class="built_in">strncpy</span>(m_real_file + len, m_url_real, <span class="built_in">strlen</span>(m_url_real));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(m_url_real);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (*(p + <span class="number">1</span>) == <span class="string">&#x27;7&#x27;</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="type">char</span> *m_url_real = (<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="type">char</span>) * <span class="number">200</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(m_url_real, <span class="string">&quot;/fans.html&quot;</span>);</span><br><span class="line">    <span class="built_in">strncpy</span>(m_real_file + len, m_url_real, <span class="built_in">strlen</span>(m_url_real));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(m_url_real);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">strncpy</span>(m_real_file + len, m_url, FILENAME_LEN - len - <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">stat</span>(m_real_file, &amp;m_file_stat) &lt; <span class="number">0</span>) <span class="comment">// 这里&lt;0就代表文件不存在了</span></span><br><span class="line">  &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NO_RESOURCE;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!(m_file_stat.st_mode &amp; S_IROTH))  <span class="comment">// S_IROTH，即是否设置了其他（other）用户的读权限</span></span><br><span class="line">    <span class="keyword">return</span> FORBIDDEN_REQUEST;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">S_ISDIR</span>(m_file_stat.st_mode)) <span class="comment">// 宏 S_ISDIR 检查 st_mode 是否表示这是一个目录</span></span><br><span class="line">    <span class="keyword">return</span> BAD_REQUEST;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> fd = <span class="built_in">open</span>(m_real_file, O_RDONLY);</span><br><span class="line">  m_file_address = (<span class="type">char</span> *)<span class="built_in">mmap</span>(<span class="literal">nullptr</span>, m_file_stat.st_size, PROT_READ, MAP_PRIVATE, fd, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">close</span>(fd);</span><br><span class="line">  <span class="keyword">return</span> FILE_REQUEST;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="process-write"><a href="#process-write" class="headerlink" title="process_write"></a>process_write</h4><p>这个process_write主要来根据处理HTTP请求的结果构建相应的HTTP响应并准备发送数据的。</p>
<p>HTTP应答的部分内容如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HTTP/<span class="number">1.0</span> <span class="number">200</span> OK</span><br><span class="line">Server:BWS/<span class="number">1.0</span></span><br><span class="line">Content-Length:<span class="number">8024</span></span><br><span class="line">Content-Type:text/html;charset=gbk</span><br><span class="line">Set-Cookie:BAIDUID=A5B6C72D68CF639CE8896FD79A03FBD8:FG=<span class="number">1</span>;expires=Wed,<span class="number">04</span>-Jul<span class="number">-42</span> <span class="number">00</span>:<span class="number">10</span>:<span class="number">47</span> GMT;path=/;domain=.baidu.com</span><br><span class="line">Via:<span class="number">1.0</span> localhost(squid/<span class="number">3.0</span> STABLE18)</span><br></pre></td></tr></table></figure>


<h5 id="add-response"><a href="#add-response" class="headerlink" title="add_response"></a>add_response</h5><p>这里定义一个基础的往HTTP<strong>响应的缓冲区</strong>添加格式化的数据的函数，并且使用可变参数<code>va_list</code>增加它的可复用性。这样我们后面的各种写数据就可以直接调用<code>add_response</code>了。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">http_conn::add_response</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *format, ...)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (m_write_idx &gt;= WRITE_BUFFER_SIZE)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  va_list arg_list;</span><br><span class="line">  <span class="built_in">va_start</span>(arg_list, format);</span><br><span class="line">  <span class="type">int</span> len = <span class="built_in">vsnprintf</span>(m_write_buf + m_write_idx, WRITE_BUFFER_SIZE - <span class="number">1</span> - m_write_idx, format, arg_list);</span><br><span class="line">  <span class="keyword">if</span> (len &gt;= (WRITE_BUFFER_SIZE - <span class="number">1</span> - m_write_idx))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">va_end</span>(arg_list);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  m_write_idx += len;</span><br><span class="line">  <span class="built_in">va_end</span>(arg_list);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">LOG_INFO</span>(<span class="string">&quot;request:%s&quot;</span>, m_write_buf)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用add_response的函数系列</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*添加状态行*/</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">http_conn::add_status_line</span><span class="params">(<span class="type">int</span> status, <span class="type">const</span> <span class="type">char</span> *title)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">add_response</span>(<span class="string">&quot;%s %d %s\r\n&quot;</span>, <span class="string">&quot;HTTP/1.1&quot;</span>, status, title);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/*添加消息报头，具体的添加长度文本 连接状态 和空行*/</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">http_conn::add_headers</span><span class="params">(<span class="type">int</span> content_len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">add_content_length</span>(content_len) &amp;&amp; <span class="built_in">add_linger</span>() &amp;&amp; <span class="built_in">add_blank_line</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">http_conn::add_content_length</span><span class="params">(<span class="type">int</span> content_len)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">add_response</span>(<span class="string">&quot;Content-Length:%d\r\n&quot;</span>, content_len);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">http_conn::add_content_type</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">add_response</span>(<span class="string">&quot;Content-Type:%s\r\n&quot;</span>, <span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">http_conn::add_linger</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">add_response</span>(<span class="string">&quot;Connection:%s\r\n&quot;</span>,(m_linger == <span class="literal">true</span>) ? <span class="string">&quot;keep-alive&quot;</span> : <span class="string">&quot;close&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">http_conn::add_blank_line</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">add_response</span>(<span class="string">&quot;%s&quot;</span>, <span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">http_conn::add_content</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *content)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">add_response</span>(<span class="string">&quot;%s&quot;</span>, content);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="process-write-1"><a href="#process-write-1" class="headerlink" title="process_write"></a>process_write</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">stat</span> m_file_stat&#123;&#125;; <span class="comment">// 目标文件的状态信息</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">iovec</span> m_iv[<span class="number">2</span>]&#123;&#125;; <span class="comment">// 用于writev操作的结构体数组。</span></span><br><span class="line"><span class="type">int</span> m_iv_count&#123;&#125;; <span class="comment">// 被用于输出的iovec结构体数量</span></span><br></pre></td></tr></table></figure>

<p>如果是<code>FILE_REQUEST</code>,我们要发两段信息，用了iovec，因为后面write用<code>writev</code>，一段是用于写缓冲区的给客户端的响应，一段是文件内容，是客户端请求的资源文件</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">http_conn::process_write</span><span class="params">(http_conn::HTTP_CODE ret)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (ret)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> INTERNAL_ERROR:</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">add_status_line</span>(<span class="number">500</span>, error_500_title);</span><br><span class="line">      <span class="built_in">add_headers</span>(<span class="built_in">strlen</span>(error_500_form));</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">add_content</span>(error_500_form))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> BAD_REQUEST:</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">add_status_line</span>(<span class="number">404</span>, error_404_title);</span><br><span class="line">      <span class="built_in">add_headers</span>(<span class="built_in">strlen</span>(error_404_form));</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">add_content</span>(error_404_form))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> FORBIDDEN_REQUEST:</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">add_status_line</span>(<span class="number">403</span>, error_403_title);</span><br><span class="line">      <span class="built_in">add_headers</span>(<span class="built_in">strlen</span>(error_403_form));</span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">add_content</span>(error_403_form))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> FILE_REQUEST:</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">add_status_line</span>(<span class="number">200</span>, ok_200_title);</span><br><span class="line">      <span class="keyword">if</span> (m_file_stat.st_size != <span class="number">0</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">add_headers</span>(m_file_stat.st_size);</span><br><span class="line">        m_iv[<span class="number">0</span>].iov_base = m_write_buf;</span><br><span class="line">        m_iv[<span class="number">0</span>].iov_len = m_write_idx;</span><br><span class="line">        m_iv[<span class="number">1</span>].iov_base = m_file_address;</span><br><span class="line">        m_iv[<span class="number">1</span>].iov_len = m_file_stat.st_size;</span><br><span class="line">        m_iv_count = <span class="number">2</span>;</span><br><span class="line">        bytes_to_send = m_write_idx + m_file_stat.st_size;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span> *ok_string = <span class="string">&quot;&lt;html&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>;</span><br><span class="line">        <span class="built_in">add_headers</span>(<span class="built_in">strlen</span>(ok_string));</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">add_content</span>(ok_string))</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">default</span>:&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  m_iv[<span class="number">0</span>].iov_base = m_write_buf;</span><br><span class="line">  m_iv[<span class="number">0</span>].iov_len = m_write_idx;</span><br><span class="line">  m_iv_count = <span class="number">1</span>;</span><br><span class="line">  bytes_to_send = m_write_idx;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="write"><a href="#write" class="headerlink" title="write"></a>write</h3><p>在写缓冲区写满要发送的数据后，我们最后调用write将其发送给浏览器客户端,如果保持连接发送完了数据后要重置各参数不返回false</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> bytes_to_send&#123;&#125;;</span><br><span class="line"><span class="type">int</span> bytes_has_send&#123;&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">http_conn::write</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> temp = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (bytes_to_send == <span class="number">0</span>) <span class="comment">// 所有响应数据已经成功发送</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">modfd</span>(m_epoll_fd, m_sock_fd, EPOLLIN, m_TRIGMode);</span><br><span class="line">    <span class="built_in">reset</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    temp = <span class="built_in">writev</span>(m_sock_fd, m_iv, m_iv_count);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (temp &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (errno == EAGAIN) <span class="comment">// 缓冲写满了</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">modfd</span>(m_epoll_fd, m_sock_fd, EPOLLOUT, m_TRIGMode);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">unmap</span>();</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    bytes_has_send += temp;</span><br><span class="line">    bytes_to_send -= temp;</span><br><span class="line">    <span class="keyword">if</span> (bytes_has_send &gt;= m_iv[<span class="number">0</span>].iov_len)</span><br><span class="line">    &#123;</span><br><span class="line">      m_iv[<span class="number">0</span>].iov_len = <span class="number">0</span>;</span><br><span class="line">      m_iv[<span class="number">1</span>].iov_base = m_file_address + (bytes_has_send - m_write_idx);</span><br><span class="line">      m_iv[<span class="number">1</span>].iov_len = bytes_to_send;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      m_iv[<span class="number">0</span>].iov_base = m_write_buf + bytes_has_send;</span><br><span class="line">      m_iv[<span class="number">0</span>].iov_len = m_iv[<span class="number">0</span>].iov_len - bytes_has_send;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bytes_to_send &lt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">unmap</span>();</span><br><span class="line">      <span class="built_in">modfd</span>(m_epoll_fd, m_sock_fd, EPOLLIN, m_TRIGMode);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (m_linger)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">reset</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="初始化工作"><a href="#初始化工作" class="headerlink" title="初始化工作"></a>初始化工作</h3><p>现在列出类中的各种参数，这样就很清晰每个参数的使用途径了</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="type">static</span> <span class="type">int</span> m_epoll_fd;</span><br><span class="line">  <span class="type">static</span> <span class="type">int</span> m_user_count;</span><br><span class="line">  MYSQL *mysql&#123;&#125;;</span><br><span class="line">  <span class="type">int</span> m_state&#123;&#125;; <span class="comment">// 0 读 1 写</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="type">int</span> m_sock_fd&#123;&#125;;</span><br><span class="line">  sockaddr_in m_address&#123;&#125;;</span><br><span class="line">  <span class="type">int</span> m_TRIGMode&#123;&#125;; <span class="comment">// 触发模式</span></span><br><span class="line">  <span class="type">char</span> *m_file_address&#123;&#125;; <span class="comment">// 请求文件被mmap到内存中的位置</span></span><br><span class="line">  <span class="type">char</span> m_read_buf[READ_BUFFER_SIZE]&#123;&#125;;</span><br><span class="line">  <span class="type">int</span> m_read_idx&#123;&#125;;</span><br><span class="line">  <span class="type">int</span> m_check_idx&#123;&#125;;</span><br><span class="line">  <span class="type">char</span> m_write_buf[WRITE_BUFFER_SIZE]&#123;&#125;;</span><br><span class="line">  <span class="type">int</span> m_write_idx&#123;&#125;;</span><br><span class="line">  <span class="type">int</span> m_start_line&#123;&#125;;</span><br><span class="line">  <span class="type">char</span> m_real_file[FILENAME_LEN]&#123;&#125;;</span><br><span class="line">  <span class="type">char</span>* doc_root&#123;&#125;; <span class="comment">// 服务器上用于存放网页文件的根目录的路径</span></span><br><span class="line">  CHECK_STATE m_check_state;</span><br><span class="line">  METHOD m_method;</span><br><span class="line">  <span class="type">char</span> *m_url&#123;&#125;;</span><br><span class="line">  <span class="type">char</span> *m_version&#123;&#125;;</span><br><span class="line">  <span class="type">char</span> *m_host&#123;&#125;;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">stat</span> m_file_stat&#123;&#125;; <span class="comment">// 目标文件的状态信息</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">iovec</span> m_iv[<span class="number">2</span>]&#123;&#125;; <span class="comment">// 用于writev操作的结构体数组。</span></span><br><span class="line">  <span class="type">int</span> m_iv_count&#123;&#125;; <span class="comment">// 被用于输出的iovec结构体数量</span></span><br><span class="line">  <span class="type">int</span> cgi&#123;&#125;; <span class="comment">//是否启用的POST</span></span><br><span class="line">  <span class="type">char</span>* m_string&#123;&#125;; <span class="comment">//存储请求体数据</span></span><br><span class="line">  <span class="type">int</span> m_close_log&#123;&#125;;</span><br><span class="line">  <span class="type">char</span> sql_user[<span class="number">100</span>]&#123;&#125;;</span><br><span class="line">  <span class="type">char</span> sql_password[<span class="number">100</span>]&#123;&#125;;</span><br><span class="line">  <span class="type">char</span> sql_name[<span class="number">100</span>]&#123;&#125;;</span><br><span class="line">  <span class="type">int</span> bytes_to_send&#123;&#125;;</span><br><span class="line">  <span class="type">int</span> bytes_has_send&#123;&#125;;</span><br><span class="line">  <span class="comment">// 用户信息和数据库配置</span></span><br><span class="line">  map&lt;string,string&gt;m_users;</span><br><span class="line">  <span class="type">bool</span> m_linger&#123;&#125;; <span class="comment">// 是否保持连接</span></span><br><span class="line">  <span class="type">long</span> m_content_length&#123;&#125;;</span><br></pre></td></tr></table></figure>


<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">http_conn::init</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">const</span> sockaddr_in &amp;addr, <span class="type">char</span> *root, <span class="type">int</span> TRIGMode,<span class="type">int</span> close_log, string user, string passwd, string sqlname)</span> </span>&#123;</span><br><span class="line">  m_sock_fd=sockfd;</span><br><span class="line">  m_TRIGMode=TRIGMode;</span><br><span class="line">  m_address=addr;</span><br><span class="line">  m_close_log=close_log;</span><br><span class="line">  <span class="built_in">addfd</span>(m_epoll_fd,m_sock_fd,<span class="literal">true</span>,TRIGMode);</span><br><span class="line">  m_user_count++;</span><br><span class="line">  <span class="comment">//当浏览器出现连接重置时，可能是网站根目录出错或http响应格式出错或者访问的文件中内容完全为空</span></span><br><span class="line">  doc_root=root;</span><br><span class="line">  <span class="built_in">strcpy</span>(sql_user,user.<span class="built_in">c_str</span>());</span><br><span class="line">  <span class="built_in">strcpy</span>(sql_password,passwd.<span class="built_in">c_str</span>());</span><br><span class="line">  <span class="built_in">strcpy</span>(sql_name,sqlname.<span class="built_in">c_str</span>());</span><br><span class="line">  <span class="built_in">reset</span>(); <span class="comment">// 主要进行私有无参的重置  在我们发送完所有的数据调用这个方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">http_conn::reset</span><span class="params">()</span> </span>&#123; <span class="comment">// 主要进行私有无参的重置  在我们发送完所有的数据调用这个方法</span></span><br><span class="line">  mysql= <span class="literal">nullptr</span>;</span><br><span class="line">  m_state=<span class="number">0</span>;</span><br><span class="line">  cgi=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  m_file_address= <span class="literal">nullptr</span>;</span><br><span class="line">  m_read_idx=<span class="number">0</span>;</span><br><span class="line">  m_check_idx=<span class="number">0</span>;</span><br><span class="line">  m_start_line=<span class="number">0</span>;</span><br><span class="line">  m_write_idx=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  m_check_state=CHECK_STATE_REQUESTLINE;</span><br><span class="line">  m_method=GET;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  m_url= <span class="literal">nullptr</span>;</span><br><span class="line">  m_version= <span class="literal">nullptr</span>;</span><br><span class="line">  m_host= <span class="literal">nullptr</span>;</span><br><span class="line">  m_string= <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">  bytes_to_send=<span class="number">0</span>;</span><br><span class="line">  bytes_has_send=<span class="number">0</span>;</span><br><span class="line">  m_content_length=<span class="number">0</span>;</span><br><span class="line">  m_linger=<span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  timer_flag=<span class="number">0</span>;</span><br><span class="line">  improv=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(m_read_buf,<span class="string">&#x27;\0&#x27;</span>,READ_BUFFER_SIZE);</span><br><span class="line">  <span class="built_in">memset</span>(m_write_buf,<span class="string">&#x27;\0&#x27;</span>,WRITE_BUFFER_SIZE);</span><br><span class="line">  <span class="built_in">memset</span>(m_real_file,<span class="string">&#x27;\0&#x27;</span>,FILENAME_LEN);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://www.yesho.top">YeSho</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://www.yesho.top/2024/04/30/%E4%B8%80%E8%B5%B7%E5%86%99webserver%20%E9%A1%B9%E7%9B%AE(%E5%9B%9B)/">https://www.yesho.top/2024/04/30/%E4%B8%80%E8%B5%B7%E5%86%99webserver%20%E9%A1%B9%E7%9B%AE(%E5%9B%9B)/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%A1%B9%E7%9B%AE/">项目</a></div><div class="post_share"><div class="social-share" data-image="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20241216191558.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/04/30/%E4%B8%80%E8%B5%B7%E5%86%99webserver%20%E9%A1%B9%E7%9B%AE(%E4%BA%94)/" title="一起写webserver 项目(五)"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20241216192124.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous</div><div class="prev_info">一起写webserver 项目(五)</div></div></a></div><div class="next-post pull-right"><a href="/2024/04/30/%E4%B8%80%E8%B5%B7%E5%86%99webserver%20%E9%A1%B9%E7%9B%AE(%E4%B8%89)/" title="一起写webserver 项目(三)"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20241216192235.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next</div><div class="next_info">一起写webserver 项目(三)</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2024/04/29/%E4%B8%80%E8%B5%B7%E5%86%99webserver%20%E9%A1%B9%E7%9B%AE(%E4%B8%80)/" title="一起写webserver 项目(一)"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20241216192235.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-29</div><div class="title">一起写webserver 项目(一)</div></div></a></div><div><a href="/2024/04/30/%E4%B8%80%E8%B5%B7%E5%86%99webserver%20%E9%A1%B9%E7%9B%AE(%E4%B8%89)/" title="一起写webserver 项目(三)"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20241216192235.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-30</div><div class="title">一起写webserver 项目(三)</div></div></a></div><div><a href="/2024/04/30/%E4%B8%80%E8%B5%B7%E5%86%99webserver%20%E9%A1%B9%E7%9B%AE(%E4%BA%94)/" title="一起写webserver 项目(五)"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20241216192124.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-30</div><div class="title">一起写webserver 项目(五)</div></div></a></div><div><a href="/2024/04/29/%E4%B8%80%E8%B5%B7%E5%86%99webserver%20%E9%A1%B9%E7%9B%AE(%E4%BA%8C)/" title="一起写webserver 项目(二)"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20241216192001.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-29</div><div class="title">一起写webserver 项目(二)</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://avatars.githubusercontent.com/u/101156528?v=4" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">YeSho</div><div class="author-info__description">C++,操作系统,算法</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">7</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">3</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">2</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/YeSho-cpp"><i class="fab fa-github"></i><span>关注我</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/YeSho-cpp" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="https://space.bilibili.com/38716159" target="_blank" title="B站"><i class="iconfont icon-querenbantubiao_Bzhan" style="color: faa-tada;"></i></a><a class="social-icon" href="https://www.zhihu.com/people/yong-shi-huai-huan-ge-can-lan-35" target="_blank" title="知乎"><i class="iconfont icon-shejiaotubiao-10" style="color: faa-tada;"></i></a><a class="social-icon" href="https://leetcode.cn/u/yong-shi-huai-huan-ge-can-lan/" target="_blank" title="力扣"><i class="iconfont icon-likou" style="color: faa-tada;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">储备的流逝</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#http%E8%BF%9E%E6%8E%A5%E7%9A%84%E5%B0%81%E8%A3%85"><span class="toc-number">1.</span> <span class="toc-text">http连接的封装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#http-conn%E7%9A%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.1.</span> <span class="toc-text">http_conn的设计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%BA%E5%AE%9A%E7%9A%84%E4%B8%80%E4%BA%9B%E6%96%B9%E6%B3%95%E5%92%8C%E5%8F%98%E9%87%8F"><span class="toc-number">1.1.1.</span> <span class="toc-text">固定的一些方法和变量</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#read-once"><span class="toc-number">1.2.</span> <span class="toc-text">read_once()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#process"><span class="toc-number">1.3.</span> <span class="toc-text">process</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#process-read"><span class="toc-number">1.3.1.</span> <span class="toc-text">process_read</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#parse-line"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">parse_line</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#parse-request-line"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">parse_request_line</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#parse-headers"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">parse_headers</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#parse-content"><span class="toc-number">1.3.1.4.</span> <span class="toc-text">parse_content</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#process-read-1"><span class="toc-number">1.3.1.5.</span> <span class="toc-text">process_read</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#do-request"><span class="toc-number">1.3.2.</span> <span class="toc-text">do_request</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#process-write"><span class="toc-number">1.3.3.</span> <span class="toc-text">process_write</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#add-response"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">add_response</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#process-write-1"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">process_write</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#write"><span class="toc-number">1.4.</span> <span class="toc-text">write</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E5%B7%A5%E4%BD%9C"><span class="toc-number">1.5.</span> <span class="toc-text">初始化工作</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/05/13/asio%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B(%E4%B8%80)/" title="asio网络编程(一)"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20241216192300.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="asio网络编程(一)"/></a><div class="content"><a class="title" href="/2024/05/13/asio%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B(%E4%B8%80)/" title="asio网络编程(一)">asio网络编程(一)</a><time datetime="2024-05-13T12:25:03.446Z" title="Created 2024-05-13 20:25:03">2024-05-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/04/30/%E4%B8%80%E8%B5%B7%E5%86%99webserver%20%E9%A1%B9%E7%9B%AE(%E4%BA%94)/" title="一起写webserver 项目(五)"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20241216192124.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="一起写webserver 项目(五)"/></a><div class="content"><a class="title" href="/2024/04/30/%E4%B8%80%E8%B5%B7%E5%86%99webserver%20%E9%A1%B9%E7%9B%AE(%E4%BA%94)/" title="一起写webserver 项目(五)">一起写webserver 项目(五)</a><time datetime="2024-04-30T13:26:36.506Z" title="Created 2024-04-30 21:26:36">2024-04-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/04/30/%E4%B8%80%E8%B5%B7%E5%86%99webserver%20%E9%A1%B9%E7%9B%AE(%E5%9B%9B)/" title="一起写webserver 项目(四)"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20241216191558.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="一起写webserver 项目(四)"/></a><div class="content"><a class="title" href="/2024/04/30/%E4%B8%80%E8%B5%B7%E5%86%99webserver%20%E9%A1%B9%E7%9B%AE(%E5%9B%9B)/" title="一起写webserver 项目(四)">一起写webserver 项目(四)</a><time datetime="2024-04-30T12:39:33.674Z" title="Created 2024-04-30 20:39:33">2024-04-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/04/30/%E4%B8%80%E8%B5%B7%E5%86%99webserver%20%E9%A1%B9%E7%9B%AE(%E4%B8%89)/" title="一起写webserver 项目(三)"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20241216192235.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="一起写webserver 项目(三)"/></a><div class="content"><a class="title" href="/2024/04/30/%E4%B8%80%E8%B5%B7%E5%86%99webserver%20%E9%A1%B9%E7%9B%AE(%E4%B8%89)/" title="一起写webserver 项目(三)">一起写webserver 项目(三)</a><time datetime="2024-04-30T03:52:00.405Z" title="Created 2024-04-30 11:52:00">2024-04-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/04/29/%E4%B8%80%E8%B5%B7%E5%86%99webserver%20%E9%A1%B9%E7%9B%AE(%E4%BA%8C)/" title="一起写webserver 项目(二)"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="http://yesho-web.oss-cn-hangzhou.aliyuncs.com/img/20241216192001.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="一起写webserver 项目(二)"/></a><div class="content"><a class="title" href="/2024/04/29/%E4%B8%80%E8%B5%B7%E5%86%99webserver%20%E9%A1%B9%E7%9B%AE(%E4%BA%8C)/" title="一起写webserver 项目(二)">一起写webserver 项目(二)</a><time datetime="2024-04-29T13:06:40.942Z" title="Created 2024-04-29 21:06:40">2024-04-29</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2024 By YeSho</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Toggle Between Traditional Chinese And Simplified Chinese">簡</button><button id="hide-aside-btn" type="button" title="Toggle between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="/js/tw_cn.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.8.8/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="30" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-nest.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/metingjs/dist/Meting.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div></body></html>